name: Production Deployment

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      manual:
        description: "Trigger manual production deployment"
        required: false
        default: "true"

env:
  AWS_REGION: me-central-1
  ECR_REPOSITORY: consentvault/api
  ECS_CLUSTER: consentvault-prod
  ECS_SERVICE: consentvault-prod-api-service
  ECS_TASK_DEFINITION: consentvault-prod-api

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f api.Dockerfile.prod -t $ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REPOSITORY:latest .
          docker push $ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REPOSITORY:latest
          echo "image=$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-infra:
    name: Deploy Infrastructure (Terraform)
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init/Plan/Apply
        working-directory: infra/terraform
        run: |
          terraform init
          terraform plan -var="domain_name=${{ secrets.PROD_DOMAIN }}" -out=tfplan
          terraform apply -auto-approve tfplan

  deploy-ecs:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infra]
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS service
        run: |
          REPO_URI=$(aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region $AWS_REGION --query 'repositories[0].repositoryUri' --output text)
          NEW_IMAGE="${REPO_URI}:${{ github.sha }}"
          TASK_DEF=$(aws ecs describe-task-definition --task-definition $ECS_TASK_DEFINITION --region $AWS_REGION --query 'taskDefinition' --output json)
          echo "$TASK_DEF" | jq ".containerDefinitions[0].image = \"$NEW_IMAGE\"" > new-task-def.json
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .registeredAt, .registeredBy, .compatibilities)' new-task-def.json > final.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final.json --region $AWS_REGION --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster $ECS_CLUSTER --service $ECS_SERVICE --task-definition "$TASK_DEF_ARN" --region $AWS_REGION --force-new-deployment
          aws ecs wait services-stable --cluster $ECS_CLUSTER --services $ECS_SERVICE --region $AWS_REGION

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-ecs]
    steps:
      - name: Verify health endpoints
        run: |
          API_URL="https://api.${{ secrets.PROD_DOMAIN }}"
          for path in healthz metrics; do
            echo "Testing $API_URL/$path"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/$path" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ $path check passed"
            else
              echo "❌ $path check failed with $HTTP_CODE"
              exit 1
            fi
          done
